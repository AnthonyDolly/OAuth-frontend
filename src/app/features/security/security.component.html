<div class="security-container">
  <!-- Header -->
  <div class="security-header">
    <div class="header-content">
      <button class="back-btn" routerLink="/dashboard">
        ‚Üê Volver al Dashboard
      </button>
      <h1>Configuraci√≥n de Seguridad</h1>
    </div>
  </div>

  <div class="security-content">
    <!-- Global Messages (for non-2FA operations) -->
    <div class="success-message" *ngIf="success && !show2FASetup">
      <i class="success-icon">‚úÖ</i>
      {{ success }}
    </div>

    <div class="error-message" *ngIf="error && !show2FASetup">
      <i class="error-icon">‚ö†Ô∏è</i>
      {{ error }}
    </div>

    <!-- Security Overview -->
    <div class="security-section" *ngIf="securityInfo">
      <h2>Resumen de Seguridad</h2>
      <div class="security-stats">
        <div class="security-stat">
          <div class="stat-icon">üîê</div>
          <div class="stat-info">
            <h3>Autenticaci√≥n de Dos Factores</h3>
            <p [class.enabled]="securityInfo.two_factor_enabled">
              {{ securityInfo.two_factor_enabled ? 'Habilitado' : 'Deshabilitado' }}
            </p>
          </div>
          <button 
            class="btn" 
            [class.btn-success]="!securityInfo.two_factor_enabled"
            [class.btn-danger]="securityInfo.two_factor_enabled"
            (click)="securityInfo.two_factor_enabled ? disable2FA() : enable2FA()"
            [disabled]="loading"
          >
            {{ securityInfo.two_factor_enabled ? 'Deshabilitar' : 'Habilitar' }}
          </button>
        </div>

        <div class="security-stat">
          <div class="stat-icon">üìß</div>
          <div class="stat-info">
            <h3>Email Verificado</h3>
            <p [class.enabled]="securityInfo.email_verified">
              {{ securityInfo.email_verified ? 'Verificado' : 'No verificado' }}
            </p>
          </div>
        </div>

        <div class="security-stat">
          <div class="stat-icon">üì±</div>
          <div class="stat-info">
            <h3>Tel√©fono Verificado</h3>
            <p [class.enabled]="securityInfo.phone_verified">
              {{ securityInfo.phone_verified ? 'Verificado' : 'No verificado' }}
            </p>
          </div>
          <button
            *ngIf="!securityInfo.phone_verified"
            class="btn btn-outline"
            (click)="navigateToPhoneVerification()"
          >
            Verificar
          </button>
        </div>

        <div class="security-stat">
          <div class="stat-icon">üîë</div>
          <div class="stat-info">
            <h3>√öltimo Login</h3>
            <p>
              {{ securityInfo.last_login_at ? formatDate(securityInfo.last_login_at.toString()) : 'Nunca' }}
            </p>
            <small *ngIf="securityInfo.last_login_ip">IP: {{ securityInfo.last_login_ip }}</small>
          </div>
        </div>
      </div>
    </div>

    <!-- 2FA Messages (specific to 2FA operations) -->
    <div class="success-message" *ngIf="twoFAMessage">
      <i class="success-icon">‚úÖ</i>
      {{ twoFAMessage }}
    </div>

    <!-- 2FA Setup -->
    <div class="security-section" *ngIf="show2FASetup">
      <h2>Configurar Autenticaci√≥n de Dos Factores</h2>
      <div class="twofa-setup">

        <!-- Step 1: QR Code and Backup Codes -->
        <div *ngIf="!show2FAVerification" class="setup-step">
          <div class="step-indicator">
            <span class="step-number active">1</span>
            <span class="step-title">Configura tu app de autenticaci√≥n</span>
          </div>

          <div class="qr-section">
            <h3>üì± Escanea el c√≥digo QR</h3>
            <img [src]="qrCode" alt="QR Code para 2FA" class="qr-code">
            <p>Usa una app como Google Authenticator, Authy o Microsoft Authenticator para escanear este c√≥digo.</p>
          </div>

          <div class="backup-codes" *ngIf="backupCodes.length > 0">
            <h3>üîê C√≥digos de Respaldo</h3>
            <p class="backup-warning">‚ö†Ô∏è <strong>IMPORTANTE:</strong> Guarda estos c√≥digos en un lugar seguro. Puedes usarlos si pierdes acceso a tu dispositivo.</p>
            <div class="codes-list">
              <code *ngFor="let code of backupCodes; trackBy: trackByCode">{{ code }}</code>
            </div>
            <div class="backup-actions">
              <button class="btn btn-outline" (click)="copyBackupCodes()">
                üìã Copiar C√≥digos
              </button>
              <button class="btn btn-outline" (click)="downloadBackupCodes()">
                üíæ Descargar C√≥digos
              </button>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn-outline" (click)="cancel2FASetup()">
              Cancelar
            </button>
            <button class="btn btn-primary" (click)="proceedToVerification()">
              Continuar ‚Üí
            </button>
          </div>
        </div>

        <!-- Step 2: TOTP Verification -->
        <div *ngIf="show2FAVerification" class="setup-step">
          <div class="step-indicator">
            <span class="step-number active">2</span>
            <span class="step-title">Verifica tu configuraci√≥n</span>
          </div>

          <div class="verification-section">
            <h3>üî¢ Ingresa el c√≥digo de verificaci√≥n</h3>
            <p>Ingresa el c√≥digo de 6 d√≠gitos que aparece en tu app de autenticaci√≥n.</p>

            <div class="verification-form">
              <input
                type="text"
                [(ngModel)]="verificationCode"
                placeholder="000000"
                maxlength="6"
                class="verification-input"
                (keyup.enter)="verifyTOTPCode()"
                [disabled]="loading"
              >

              <button
                class="btn btn-primary"
                (click)="verifyTOTPCode()"
                [disabled]="loading || !verificationCode || verificationCode.length !== 6"
              >
                <span *ngIf="!loading">Verificar C√≥digo</span>
                <span *ngIf="loading" class="loading-spinner">Verificando...</span>
              </button>
            </div>

            <div *ngIf="verificationError" class="verification-error">
              ‚ùå {{ verificationError }}
            </div>

            <div class="verification-help">
              <p>¬øNo funciona el c√≥digo?</p>
              <ul>
                <li>Aseg√∫rate de que la hora de tu dispositivo est√© correcta</li>
                <li>Espera 30 segundos para que se genere un nuevo c√≥digo</li>
                <li>Verifica que hayas escaneado correctamente el c√≥digo QR</li>
              </ul>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn-outline" (click)="show2FAVerification = false">
              ‚Üê Volver
            </button>
            <button class="btn btn-danger" (click)="cancel2FASetup()">
              Cancelar Configuraci√≥n
            </button>
          </div>
        </div>

      </div>
    </div>

    <!-- Change Password -->
    <div class="security-section">
      <h2>Cambiar Contrase√±a</h2>

      <!-- √âxito espec√≠fico para el formulario de cambio de contrase√±a -->
      <div class="success-message" *ngIf="passwordSuccess">
        <i class="success-icon">‚úÖ</i>
        {{ passwordSuccess }}
      </div>

      <!-- Error espec√≠fico para el formulario de cambio de contrase√±a -->
      <div class="error-message" *ngIf="passwordError">
        <i class="error-icon">‚ö†Ô∏è</i>
        {{ passwordError }}
      </div>

      <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePassword()" class="password-form">
        <div class="form-group">
          <label for="current_password">Contrase√±a Actual</label>
          <input
            id="current_password"
            type="password"
            formControlName="current_password"
            placeholder="Tu contrase√±a actual"
            [class.error]="isFieldInvalid(changePasswordForm, 'current_password')"
          >
          <div class="field-error" *ngIf="isFieldInvalid(changePasswordForm, 'current_password')">
            {{ getFieldError(changePasswordForm, 'current_password') }}
          </div>
        </div>

        <div class="form-group">
          <label for="new_password">Nueva Contrase√±a</label>
          <input
            id="new_password"
            type="password"
            formControlName="new_password"
            placeholder="Nueva contrase√±a (m√≠n. 8 caracteres)"
            [class.error]="isFieldInvalid(changePasswordForm, 'new_password')"
          >
          <div class="field-error" *ngIf="isFieldInvalid(changePasswordForm, 'new_password')">
            {{ getFieldError(changePasswordForm, 'new_password') }}
          </div>
          <div class="field-help">
            La contrase√±a debe contener al menos 8 caracteres, una may√∫scula, una min√∫scula y un n√∫mero.
          </div>
        </div>

        <div class="form-group">
          <label for="confirm_password">Confirmar Nueva Contrase√±a</label>
          <input
            id="confirm_password"
            type="password"
            formControlName="confirm_password"
            placeholder="Repite la nueva contrase√±a"
            [class.error]="isFieldInvalid(changePasswordForm, 'confirm_password')"
          >
          <div class="field-error" *ngIf="isFieldInvalid(changePasswordForm, 'confirm_password')">
            {{ getFieldError(changePasswordForm, 'confirm_password') }}
          </div>
        </div>

        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="loading || changePasswordForm.invalid"
        >
          <span *ngIf="!loading">Cambiar Contrase√±a</span>
          <span *ngIf="loading" class="loading-spinner">Cambiando...</span>
        </button>
      </form>
    </div>

    <!-- Phone Verification Section -->
    <div class="security-section phone-verification-section" *ngIf="showPhoneVerificationSection">
      <div class="section-header">
        <h2>Verificar Tel√©fono</h2>
        <p>Agrega verificaci√≥n de dos factores a tu cuenta mediante SMS</p>
      </div>

      <!-- Phone Verification Messages -->
      <div class="success-message" *ngIf="success && showPhoneVerificationSection">
        <i class="success-icon">‚úÖ</i>
        {{ success }}
      </div>

      <div class="error-message" *ngIf="error && showPhoneVerificationSection">
        <i class="error-icon">‚ö†Ô∏è</i>
        {{ error }}
      </div>

      <form [formGroup]="phoneVerificationForm" class="phone-verification-content">
        <div class="verification-step" *ngIf="!phoneVerificationSent">
          <div class="step-icon">üìû</div>
          <h3>Paso 1: Ingresa tu n√∫mero de tel√©fono</h3>
          <p>Te enviaremos un c√≥digo de verificaci√≥n por SMS</p>

          <div class="phone-input-section">
            <input
              id="phone"
              type="tel"
              placeholder="+1234567890"
              formControlName="phone"
              autocomplete="tel"
              [class.error]="isFieldInvalid(phoneVerificationForm, 'phone')"
              (input)="onPhoneInputChange()"
            >
            <button
              class="btn btn-primary"
              (click)="sendPhoneVerification()"
              [disabled]="isSendButtonDisabled()"
            >
              <span *ngIf="!loading">üì§ Enviar C√≥digo</span>
              <span *ngIf="loading" class="loading-spinner">Enviando...</span>
            </button>
          </div>

          <div class="field-error" *ngIf="isFieldInvalid(phoneVerificationForm, 'phone')">
            {{ getFieldError(phoneVerificationForm, 'phone') }}
          </div>
        </div>

        <div class="verification-step" *ngIf="phoneVerificationSent">
          <div class="step-icon">üî¢</div>
          <h3>Paso 2: Ingresa el c√≥digo de verificaci√≥n</h3>
          <p>Revisa tu tel√©fono e ingresa el c√≥digo de 6 d√≠gitos que recibiste</p>

          <div class="code-input-section">
            <input
              id="code"
              type="text"
              placeholder="123456"
              maxlength="6"
              formControlName="code"
              autocomplete="one-time-code"
              [class.error]="isFieldInvalid(phoneVerificationForm, 'code')"
              (input)="onCodeInputChange()"
            >
            <button
              class="btn btn-success"
              (click)="verifyPhone()"
              [disabled]="isVerifyButtonDisabled()"
            >
              <span *ngIf="!loading">‚úÖ Verificar C√≥digo</span>
              <span *ngIf="loading" class="loading-spinner">Verificando...</span>
            </button>
          </div>

          <div class="field-error" *ngIf="isFieldInvalid(phoneVerificationForm, 'code')">
            {{ getFieldError(phoneVerificationForm, 'code') }}
          </div>

          <div class="verification-help">
            <p>¬øNo recibiste el c√≥digo?</p>
            <ul>
              <li>Espera unos segundos, puede tardar en llegar</li>
              <li>Revisa tu carpeta de spam o mensajes no deseados</li>
              <li>Aseg√∫rate de que tu n√∫mero de tel√©fono sea correcto</li>
              <li><button class="btn-link" (click)="phoneVerificationSent = false; phoneVerificationForm.patchValue({ code: '' })">Cambiar n√∫mero de tel√©fono</button></li>
            </ul>
          </div>
        </div>

        <div class="step-actions">
          <button class="btn btn-outline" (click)="cancelPhoneVerification()">
            Cancelar
          </button>
        </div>
      </form>
    </div>

    <!-- Old Phone Verification (kept for backward compatibility) -->
    <div class="security-section" *ngIf="showPhoneVerification">
      <h2>Verificar Tel√©fono</h2>
      <form [formGroup]="phoneVerificationForm" class="phone-form">
        <div class="form-group" *ngIf="!phoneVerificationSent">
          <label for="phone">N√∫mero de Tel√©fono</label>
          <input
            id="phone"
            type="tel"
            formControlName="phone"
            placeholder="+1234567890"
            [class.error]="isFieldInvalid(phoneVerificationForm, 'phone')"
          >
          <button
            type="button"
            class="btn btn-primary"
            (click)="sendPhoneVerification()"
            [disabled]="loading"
          >
            Enviar C√≥digo
          </button>
        </div>

        <div class="form-group" *ngIf="phoneVerificationSent">
          <label for="code">C√≥digo de Verificaci√≥n</label>
          <input
            id="code"
            type="text"
            formControlName="code"
            placeholder="123456"
            maxlength="6"
            [class.error]="isFieldInvalid(phoneVerificationForm, 'code')"
          >
          <button
            type="button"
            class="btn btn-primary"
            (click)="verifyPhone()"
            [disabled]="loading"
          >
            Verificar
          </button>
        </div>

        <button
          type="button"
          class="btn btn-outline"
          (click)="showPhoneVerification = false; phoneVerificationSent = false; phoneVerificationForm.reset()"
        >
          Cancelar
        </button>
      </form>
    </div>
  </div>
</div>
